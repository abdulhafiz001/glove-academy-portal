import{c as ge,u as ue,r as i,A as j,j as e,C as N}from"./app-17JNjqSJ.js";import{A as I}from"./AdminLayout-DXkI0PI6.js";import{C as q}from"./calendar-BfCctGZ3.js";import{S as he}from"./school-CkSRFjxx.js";import{U as H}from"./users-BUbPeWYP.js";import{C as B}from"./circle-check-Cgpd_CsW.js";import{C as fe}from"./clock-BhLQzzKh.js";import{S as pe}from"./save-CvmKl75M.js";import"./file-text-Znh3F_nC.js";import"./book-open-D3qBa7nK.js";import"./user-CAmUnVMn.js";import"./log-out-Bc-nJCmd.js";import"./menu-BL5-W5Xp.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const be=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],ye=ge("refresh-cw",be),Ee=()=>{var P;const{showSuccess:G,showError:y}=ue(),[J,K]=i.useState(!0),[c,Q]=i.useState(null),[h,V]=i.useState(null),[R,X]=i.useState([]),[a,Y]=i.useState(null),[t,D]=i.useState(null),[x,E]=i.useState([]),[g,Z]=i.useState(1),[p,ee]=i.useState("Monday"),[b,se]=i.useState(new Date().toISOString().split("T")[0]),[f,F]=i.useState({}),[w,W]=i.useState({}),[L,O]=i.useState(!1),[k,T]=i.useState([]),[u,re]=i.useState(!1),[ae,z]=i.useState(!1);i.useRef({classId:null,subjectId:null,week:null,sessionId:null,term:null});const te=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],A=i.useCallback(s=>s?typeof s=="string"&&/^\d{4}-\d{2}-\d{2}$/.test(s)?s:s instanceof Date?s.toISOString().split("T")[0]:typeof s=="string"?s.split("T")[0]:s:null,[]),S=i.useMemo(()=>{const s=x.length,r=Object.values(f).filter(o=>o==="present").length,n=Object.values(f).filter(o=>o==="absent").length,l=Object.values(f).filter(o=>o==="late").length,d=s>0?Math.round((r+l)/s*100):0;return{total:s,present:r,absent:n,late:l,percent:d}},[f,x.length]);i.useEffect(()=>{ne(),de()},[]),i.useEffect(()=>{a!=null&&a.id&&(t!=null&&t.id)&&(c!=null&&c.id)&&g?$():T([])},[a==null?void 0:a.id,t==null?void 0:t.id,g,c==null?void 0:c.id,h==null?void 0:h.name]),i.useEffect(()=>{a!=null&&a.id&&(t!=null&&t.id)?ie():E([])},[a==null?void 0:a.id,t==null?void 0:t.id]),i.useEffect(()=>{if(x.length===0)return;const s=A(b),r=p.trim(),n=Number(g);let l=!1;const d={},o={};if(k.length>0)for(const m of k){if(!m.records||!Array.isArray(m.records))continue;const U=m.student_id,v=m.records.find(_=>{const ce=A(_.date),me=Number(_.week),xe=String(_.day).trim();return me===n&&ce===s&&xe===r});v&&(l=!0,d[U]=v.status||"present",v.remark&&(o[U]=v.remark))}re(l);const C={},M={};x.forEach(m=>{l&&d[m.id]?(C[m.id]=d[m.id],M[m.id]=o[m.id]||""):(C[m.id]="present",M[m.id]="")}),F(C),W(M)},[k,p,b,x,g,A]);const ne=async()=>{try{const s=await j.getCurrentAcademicSession(),r=(s==null?void 0:s.data)||s,n=(r==null?void 0:r.session)||(r==null?void 0:r.academic_session)||(s==null?void 0:s.session),l=(r==null?void 0:r.term)||(s==null?void 0:s.term);n&&Q(n),l&&V(l)}catch(s){console.error(s),y("Failed to load session info")}finally{K(!1)}},de=async()=>{var s;try{const r=await j.getTeacherAttendanceClasses(),n=Array.isArray(r)?r:((s=r==null?void 0:r.data)==null?void 0:s.data)||(r==null?void 0:r.data)||[];X(n)}catch(r){console.error(r)}},ie=async()=>{var s;try{const r=await j.getClassStudentsForAttendance(a.id,t.id),n=Array.isArray(r)?r:((s=r==null?void 0:r.data)==null?void 0:s.data)||(r==null?void 0:r.data)||[];E(n)}catch{y("Error loading students")}},$=async()=>{var s,r,n;if(!(!(a!=null&&a.id)||!(t!=null&&t.id)||!g||!(c!=null&&c.id))){z(!0);try{const l={class_id:a.id,subject_id:t.id,week:g,academic_session_id:c.id,term:h==null?void 0:h.name},d=await j.getAttendanceRecords(l);let o=[];Array.isArray(d)?o=d:d!=null&&d.data?o=Array.isArray(d.data)?d.data:[]:(s=d==null?void 0:d.data)!=null&&s.data&&(o=Array.isArray(d.data.data)?d.data.data:[]),T(o)}catch(l){console.error("Fetch error:",l);const d=((n=(r=l.response)==null?void 0:r.data)==null?void 0:n.message)||l.message||"Failed to refresh records";y(d)}finally{z(!1)}}},le=i.useCallback(async()=>{if(!(a!=null&&a.id)||!(t!=null&&t.id)||!b){y("Please check all fields.");return}O(!0);try{const s=x.map(n=>({student_id:n.id,status:f[n.id]||"present",remark:w[n.id]||null})),r={class_id:a.id,subject_id:t.id,week:g,day:p,date:b,attendances:s};await j.markAttendance(r),G(`Attendance marked for ${p}`),await $()}catch(s){y(s.message||"Error saving attendance")}finally{O(!1)}},[a,t,g,p,b,x,f,w]),oe=s=>{switch(s){case"present":return"bg-green-50 text-green-700 border-green-200";case"absent":return"bg-red-50 text-red-700 border-red-200";case"late":return"bg-yellow-50 text-yellow-700 border-yellow-200";case"excused":return"bg-blue-50 text-blue-700 border-blue-200";default:return"bg-gray-50 text-gray-700 border-gray-200"}};return J?e.jsx(I,{children:e.jsxs("div",{className:"flex flex-col items-center justify-center h-96",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 mb-4",style:{borderColor:N.primary.red}}),e.jsx("p",{className:"text-gray-500 font-medium",children:"Loading portal..."})]})}):!c||!h?e.jsx(I,{children:e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 max-w-md text-center border-t-4",style:{borderColor:N.primary.red},children:[e.jsx(q,{className:"h-16 w-16 mx-auto text-gray-300 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"Session Not Configured"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Contact admin to set active session."})]})})}):e.jsx(I,{children:e.jsx("div",{className:"p-4 md:p-8 bg-gray-50 min-h-screen",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold text-gray-900",children:"Class Attendance"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"Manage and track student presence"})]}),e.jsxs("div",{className:"bg-white px-5 py-3 rounded-lg shadow-sm border border-gray-200 flex items-center gap-4",children:[e.jsx("div",{className:"bg-red-50 p-2 rounded-full",children:e.jsx(q,{className:"h-5 w-5",style:{color:N.primary.red}})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 uppercase font-semibold tracking-wider",children:"Session"}),e.jsxs("div",{className:"flex items-center gap-2 font-medium text-gray-800",children:[e.jsx("span",{children:c.name}),e.jsx("span",{className:"text-gray-300",children:"â€¢"}),e.jsx("span",{children:h.name})]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"p-6 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-800 flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-gray-500"}),"Configuration"]}),ae&&e.jsxs("span",{className:"text-xs text-blue-600 flex items-center gap-1 animate-pulse",children:[e.jsx(ye,{className:"h-3 w-3 animate-spin"}),"Syncing Week..."]})]}),e.jsxs("div",{className:"p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-6",children:[e.jsxs("div",{className:"lg:col-span-5 space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1.5",children:"Class"}),e.jsxs("select",{value:(a==null?void 0:a.id)||"",onChange:s=>{const r=R.find(n=>n.id===parseInt(s.target.value));Y(r),D(null)},className:"w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500/20 focus:border-red-500 bg-white",children:[e.jsx("option",{value:"",children:"Select Class"}),R.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1.5",children:"Subject"}),e.jsxs("select",{value:(t==null?void 0:t.id)||"",onChange:s=>{var r;return D((r=a==null?void 0:a.subjects)==null?void 0:r.find(n=>n.id===parseInt(s.target.value)))},disabled:!a,className:"w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500/20 focus:border-red-500 bg-white disabled:bg-gray-50",children:[e.jsx("option",{value:"",children:"Select Subject"}),(P=a==null?void 0:a.subjects)==null?void 0:P.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})]}),e.jsx("div",{className:"hidden lg:block lg:col-span-1 border-l border-gray-200 mx-auto h-full"}),e.jsxs("div",{className:"lg:col-span-6 grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1.5",children:"Week"}),e.jsx("select",{value:g,onChange:s=>Z(parseInt(s.target.value)),className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500",children:Array.from({length:14},(s,r)=>r+1).map(s=>e.jsxs("option",{value:s,children:["Week ",s]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1.5",children:"Day"}),e.jsx("select",{value:p,onChange:s=>ee(s.target.value),className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500",children:te.map(s=>e.jsx("option",{value:s,children:s},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1.5",children:"Date"}),e.jsx("input",{type:"date",value:b,onChange:s=>se(s.target.value),className:"w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500"})]})]})]})]}),x.length>0?e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"bg-gray-50 border-b border-gray-200 p-4 sticky top-0 z-10 flex flex-wrap gap-4 items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("h3",{className:"font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5 text-gray-500"}),"Students (",x.length,")"]}),u?e.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200 animate-in fade-in duration-300",children:[e.jsx(B,{className:"h-3.5 w-3.5"}),"Marked"]}):e.jsx("span",{className:"inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-gray-100 text-gray-600 border border-gray-200",children:"Not Marked"})]}),e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsxs("div",{className:"px-3 py-1 bg-green-100 text-green-700 rounded-md font-medium border border-green-200",children:["P: ",S.present]}),e.jsxs("div",{className:"px-3 py-1 bg-red-100 text-red-700 rounded-md font-medium border border-red-200",children:["A: ",S.absent]}),e.jsxs("div",{className:"hidden sm:block px-3 py-1 bg-gray-100 text-gray-600 rounded-md font-medium border border-gray-200",children:[S.percent,"%"]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left border-collapse",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-xs uppercase tracking-wider text-gray-500 border-b border-gray-200",children:[e.jsx("th",{className:"px-6 py-4 font-semibold w-16",children:"#"}),e.jsx("th",{className:"px-6 py-4 font-semibold",children:"Student Info"}),e.jsx("th",{className:"px-6 py-4 font-semibold w-48",children:"Status"}),e.jsx("th",{className:"px-6 py-4 font-semibold",children:"Remark"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:x.map((s,r)=>{const n=f[s.id]||"present";return e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4 text-gray-500 font-medium",children:r+1}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[s.last_name,", ",s.first_name," ",s.middle_name]}),e.jsx("div",{className:"text-xs text-gray-500 mt-0.5",children:s.admission_number})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("select",{value:n,onChange:l=>F(d=>({...d,[s.id]:l.target.value})),disabled:u,className:`w-full px-3 py-2 rounded-lg text-sm font-medium border focus:ring-2 focus:ring-offset-1 transition-all outline-none appearance-none text-center ${oe(n)} ${u?"opacity-70 cursor-not-allowed":"cursor-pointer"}`,children:[e.jsx("option",{value:"present",children:"Present"}),e.jsx("option",{value:"absent",children:"Absent"}),e.jsx("option",{value:"late",children:"Late"}),e.jsx("option",{value:"excused",children:"Excused"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"text",value:w[s.id]||"",onChange:l=>W(d=>({...d,[s.id]:l.target.value})),disabled:u,placeholder:u?"-":"Add note...",className:"w-full bg-transparent border-b border-gray-200 py-1 text-sm focus:border-red-500 focus:outline-none placeholder-gray-300"})})]},s.id)})})]})}),e.jsxs("div",{className:"p-6 bg-gray-50 border-t border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{className:"text-sm text-gray-500 flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4"}),e.jsx("span",{children:new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("button",{onClick:le,disabled:L||x.length===0||u,className:`
                                    flex items-center justify-center gap-2 px-8 py-3 rounded-lg font-semibold text-white shadow-md transition-all
                                    ${u?"bg-green-600 cursor-not-allowed opacity-90":"bg-red-600 hover:bg-red-700 hover:shadow-lg active:transform active:scale-95"}
                                    disabled:opacity-50 disabled:cursor-not-allowed
                                `,style:{backgroundColor:u?void 0:N.primary.red},children:L?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"}),e.jsx("span",{children:"Saving..."})]}):u?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"h-5 w-5"}),e.jsx("span",{children:"Attendance Marked"})]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-5 w-5"}),e.jsx("span",{children:"Submit Attendance"})]})})]})]}):e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx("div",{className:"bg-gray-50 h-16 w-16 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx(H,{className:"h-8 w-8 text-gray-300"})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-1",children:"Select Class"}),e.jsx("p",{className:"text-gray-500",children:"Choose a class and subject to view students."})]})]})})})};export{Ee as default};
