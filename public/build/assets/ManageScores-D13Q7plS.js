import{r as f,d as b,u as Pe,a as Oe,A as C,j as e,X as De}from"./app-17JNjqSJ.js";import{A as he}from"./AdminLayout-DXkI0PI6.js";import{D as be}from"./download-7IDGFHuP.js";import{U as $e}from"./upload-f9lC6ujl.js";import{P as pe}from"./plus-CyYmu38g.js";import{T as Re}from"./trending-up-X4Mvz1sM.js";import{S as Le}from"./search-Dk6ZNiIw.js";import{S as Ue}from"./square-pen-Bg_diimZ.js";import"./users-BUbPeWYP.js";import"./file-text-Znh3F_nC.js";import"./calendar-BfCctGZ3.js";import"./book-open-D3qBa7nK.js";import"./user-CAmUnVMn.js";import"./log-out-Bc-nJCmd.js";import"./menu-BL5-W5Xp.js";const ls=({initialAcademicSession:W,initialCurrentTerm:X,initialTeacherAssignments:N,initialAdminClasses:L,initialAdminSubjects:H})=>{const[g,je]=f.useState(""),[p,re]=f.useState(""),[O,ye]=f.useState(""),[u,I]=f.useState({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),[U,A]=f.useState("first"),[F,D]=f.useState(null),[k,M]=f.useState(null),[ce,le]=f.useState(!1),[ze,qe]=f.useState(!1),[Ve,Ge]=f.useState({isOpen:!1,scoreId:null}),[ne,oe]=f.useState(N||[]),[P,K]=f.useState(N||L||[]),[G,Q]=f.useState(H||[]);f.useEffect(()=>{var s;N&&N.length>0&&b.component("ManageScores","Initial teacher assignments received",{count:N.length,firstClass:N[0],firstClassSubjects:(s=N[0])==null?void 0:s.subjects})},[N]);const[j,Y]=f.useState([]),[Se,$]=f.useState({}),[Ne,z]=f.useState(!1),[_e,q]=f.useState(!1),[x,R]=f.useState({isOpen:!1,importing:!1,selectedClassId:null,selectedSubjectId:null}),[J,de]=f.useState(null),[Z,ve]=f.useState(W||null),[_,we]=f.useState(X||null),{showError:h,showSuccess:V}=Pe(),{user:o}=Oe(),ee=f.useRef(!1);f.useEffect(()=>{var s,t,a,l,r,i,m;if(o!=null&&o.id&&!ee.current)if(ee.current=!0,b.component("ManageScores","Component initialized",{userRole:o==null?void 0:o.role}),(o==null?void 0:o.role)==="teacher"&&N&&N.length>0||(o==null?void 0:o.role)==="admin"&&L&&L.length>0){if((o==null?void 0:o.role)==="teacher"&&N){const c=JSON.parse(JSON.stringify(Array.isArray(N)?N:[]));oe(c),K(c),b.component("ManageScores","Initial teacher assignments",{assignmentsCount:c.length,firstClass:c[0],firstClassId:(s=c[0])==null?void 0:s.id,firstClassName:(t=c[0])==null?void 0:t.name,firstClassSubjects:(a=c[0])==null?void 0:a.subjects,firstClassSubjectsLength:((r=(l=c[0])==null?void 0:l.subjects)==null?void 0:r.length)||0,firstClassSubjectsType:typeof((i=c[0])==null?void 0:i.subjects),firstClassSubjectsIsArray:Array.isArray((m=c[0])==null?void 0:m.subjects)});const d=[];c.forEach(y=>{y&&y.subjects&&(Array.isArray(y.subjects)?y.subjects:[]).forEach(v=>{const T=typeof v=="object"&&v!==null?v:{id:v};if(T&&T.id){const E=typeof T.id=="string"?parseInt(T.id):T.id;d.find(w=>(typeof w.id=="string"?parseInt(w.id):w.id)===E)||d.push({id:E,name:T.name||`Subject ${E}`})}})}),b.component("ManageScores","Extracted all subjects",{subjectsCount:d.length,subjects:d}),Q(d),b.component("ManageScores","Extracted subjects",{subjectsCount:d.length,subjects:d.map(y=>({id:y.id,name:y.name}))})}else(o==null?void 0:o.role)==="admin"&&L&&H&&(K(L),Q(H));(!W||!X)&&ie(),z(!1)}else z(!0),(async()=>{try{if((o==null?void 0:o.role)==="teacher")await Ce();else if((o==null?void 0:o.role)==="admin")await Ie();else{z(!1);return}(!W||!X)&&await ie()}catch{h("Failed to load data. Please refresh the page.")}finally{z(!1)}})();else if(!(o!=null&&o.id)&&!ee.current){z(!0);const S=setTimeout(()=>{z(!1),ee.current=!0},2e3);return()=>clearTimeout(S)}},[o==null?void 0:o.id,N,L,H,W,X]);const ie=async()=>{try{const s=await C.getCurrentAcademicSession(),t=s.data||s;ve(t.session),we(t.term),t.term&&t.term.name&&A(t.term.name)}catch{}};f.useEffect(()=>{g&&p&&Array.isArray(j)&&j.length>0?B(j,g,p):$({})},[g,p,j]);const Ce=async()=>{var s;try{const t=await C.getTeacherAssignmentsForScores();b.component("ManageScores","fetchTeacherAssignments - Response received");let a=[];Array.isArray(t)?a=t:t!=null&&t.data?a=Array.isArray(t.data)?t.data:[]:(s=t==null?void 0:t.data)!=null&&s.data&&(a=Array.isArray(t.data.data)?t.data.data:[]),b.component("ManageScores","fetchTeacherAssignments - Assignments processed",{count:a.length}),oe(a),K(a);const l=[];a.forEach(r=>{r&&r.subjects&&(Array.isArray(r.subjects)?r.subjects:[]).forEach(m=>{m&&m.id&&!l.find(S=>S.id===m.id)&&l.push(m)})}),Q(l),b.component("ManageScores","fetchTeacherAssignments - Available data set",{classes:a.length,subjects:l.length})}catch(t){throw h("Failed to load teacher assignments"),t}},Ie=async()=>{var s;try{b.component("ManageScores","fetchAdminData - Starting");const[t,a]=await Promise.all([C.getClasses(),C.getSubjects()]);let l=[];Array.isArray(t)?l=t:(s=t==null?void 0:t.data)!=null&&s.data&&Array.isArray(t.data.data)?l=t.data.data:t!=null&&t.data&&Array.isArray(t.data)&&(l=t.data);let r=[];Array.isArray(a)?r=a:a!=null&&a.data&&Array.isArray(a.data)&&(r=a.data),b.component("ManageScores","fetchAdminData - Data loaded",{classesCount:l.length,subjectsCount:r.length}),K(l),Q(r)}catch(t){throw h("Failed to load classes and subjects"),t}};f.useEffect(()=>{g&&p?me():Y([])},[g,p]);const me=async()=>{if(!(!g||!p))try{const s=await C.getStudentsForClassSubject(g,p),t=s.data||s;Y(t),await B(t,g,p)}catch{h("Failed to load students for the selected class and subject")}},B=async(s,t=null,a=null)=>{try{const l=t||g,r=a||p;if(b.component("ManageScores","loadStudentScores - Starting",{studentsCount:s.length,class:l,subject:r}),!s||s.length===0||!l||!r){$({});return}$({});const i=typeof l=="string"?parseInt(l):l,m=typeof r=="string"?parseInt(r):r,S=["first","second","third"],c=S.map(n=>C.getExistingScores(i,m,n)),d=await Promise.all(c);b.component("ManageScores","loadStudentScores - Responses received",{count:d.length,responses:d.map((n,v)=>({term:S[v],hasData:!!n,dataType:Array.isArray(n==null?void 0:n.data)?"array":typeof(n==null?void 0:n.data),dataLength:Array.isArray(n==null?void 0:n.data)?n.data.length:0}))});const y={};s.forEach(n=>{y[n.id]={}}),d.forEach((n,v)=>{var ae;const T=S[v];let E=[];Array.isArray(n)?E=n:Array.isArray(n==null?void 0:n.data)?E=n.data:(ae=n==null?void 0:n.data)!=null&&ae.scores&&Array.isArray(n.data.scores)?E=n.data.scores:n!=null&&n.scores&&Array.isArray(n.scores)&&(E=n.scores),b.component("ManageScores",`loadStudentScores - Processing ${T} term scores`,{term:T,scoresCount:E.length,firstScore:E[0]}),E.forEach(w=>{const te=typeof w.student_id=="string"?parseInt(w.student_id):w.student_id,Me=typeof w.subject_id=="string"?parseInt(w.subject_id):w.subject_id,Te=typeof w.class_id=="string"?parseInt(w.class_id):w.class_id;te&&Me===m&&Te===i&&y[te]&&(y[te][T]=w)})}),b.component("ManageScores","loadStudentScores - Scores loaded",{studentsWithScores:Object.keys(y).filter(n=>Object.keys(y[n]).length>0).length,totalStudents:s.length,scoresMap:Object.keys(y).reduce((n,v)=>(n[v]=Object.keys(y[v]),n),{})}),$(y)}catch{h("Failed to load scores. Please try again."),$({})}},Ae=s=>{je(s),re(""),Y([]),$({})},ke=s=>{re(s),Y([]),$({}),q(!1),M(null),D(null),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""})},se=(s,t)=>{if(s==="first_ca"||s==="second_ca"||s==="exam_score"){const a=t===""?0:parseFloat(t);if(!isNaN(a)&&a>100){h("Individual score cannot exceed 100");return}I(l=>{const r={first_ca:s==="first_ca"?a:parseFloat(l.first_ca)||0,second_ca:s==="second_ca"?a:parseFloat(l.second_ca)||0,exam_score:s==="exam_score"?a:parseFloat(l.exam_score)||0},i=r.first_ca+r.second_ca+r.exam_score;return i>100?(h(`Total score cannot exceed 100. Current total would be ${i.toFixed(1)}. Please adjust the scores.`),l):{...l,[s]:t===""?"":parseFloat(t)}});return}I(a=>({...a,[s]:t}))},ue=s=>s>=80?"A":s>=70?"B":s>=60?"C":s>=50?"D":s>=40?"E":"F",Fe=async()=>{if(!F){h("Please select a student");return}if(!u.first_ca&&!u.second_ca&&!u.exam_score){h("Please fill in at least one score field");return}const s=(parseFloat(u.first_ca)||0)+(parseFloat(u.second_ca)||0)+(parseFloat(u.exam_score)||0);if(s>100){h(`Total score cannot exceed 100. Current total is ${s.toFixed(1)}. Please adjust the scores.`);return}if(u.first_ca&&parseFloat(u.first_ca)>100){h("1st CA score cannot exceed 100");return}if(u.second_ca&&parseFloat(u.second_ca)>100){h("2nd CA score cannot exceed 100");return}if(u.exam_score&&parseFloat(u.exam_score)>100){h("Exam score cannot exceed 100");return}const t=ue(s);le(!0);try{const a={student_id:F.id,subject_id:p,class_id:g,term:U,first_ca:u.first_ca?parseFloat(u.first_ca):null,second_ca:u.second_ca?parseFloat(u.second_ca):null,exam_score:u.exam_score?parseFloat(u.exam_score):null,total_score:s,grade:t,remark:u.remark||""};k?(b.component("ManageScores","handleSaveScore - Updating score",{scoreId:k.id}),await C.updateScore(k.id,a),V("Score updated successfully")):(b.component("ManageScores","handleSaveScore - Creating score"),await C.createScore(a),V("Score saved successfully")),await me(),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),D(null),M(null),q(!1),V(k?"Score updated successfully":"Score saved successfully")}catch(a){h(a.message||"Failed to save score")}finally{le(!1)}},Ee=(s,t)=>{if((t.subject_id||t.subject&&t.subject.id)!=p){h("This score does not belong to the selected subject. Please select the correct subject first.");return}b.component("ManageScores","handleEditScore - Editing score",{scoreId:t==null?void 0:t.id}),D(s),M(t),I({first_ca:t.first_ca||"",second_ca:t.second_ca||"",exam_score:t.exam_score||"",total_score:t.total_score||"",grade:t.grade||"",remark:t.remark||""}),A(t.term),q(!0),b.component("ManageScores","handleEditScore - Form opened",{studentName:`${s.first_name} ${s.last_name}`,subject:p})},xe=async(s,t,a=null,l=null)=>{try{const r=a||g,i=l||p;if(!r||!i){M(null),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),A(t);return}const m=await C.getStudentScores(s,{class_id:r,subject_id:i}),c=(m.data||m||[]).find(d=>d.term===t&&(d.subject_id==i||d.subject&&d.subject.id==i));c?(M(c),I({first_ca:c.first_ca||"",second_ca:c.second_ca||"",exam_score:c.exam_score||"",total_score:c.total_score||"",grade:c.grade||"",remark:c.remark||""}),A(t)):(M(null),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),A(t))}catch{M(null),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),A(t)}},fe=()=>{I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),D(null),M(null),q(!1),A("first"),Array.isArray(j)&&j.length>0&&B(j,g,p)},ge=f.useMemo(()=>Array.isArray(j)?!O||O===""?j:j.filter(s=>{var t,a,l;return((t=s.first_name)==null?void 0:t.toLowerCase().includes(O.toLowerCase()))||((a=s.last_name)==null?void 0:a.toLowerCase().includes(O.toLowerCase()))||((l=s.admission_number)==null?void 0:l.toLowerCase().includes(O.toLowerCase()))}):[],[j,O]);return Ne?e.jsx(he,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"})})}):e.jsx(he,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold leading-7 text-gray-900 sm:text-3xl",children:"Manage Scores"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Record and manage student scores for your assigned classes and subjects."})]}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsxs("button",{onClick:async()=>{try{const s={};g&&(s.class_id=g),U&&(s.term=U),await C.exportScores(s),V("Scores exported successfully")}catch(s){h(s.message||"Failed to export scores")}},className:"inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Export"]}),e.jsxs("button",{onClick:()=>{b.component("ManageScores","Opening import modal",{classesCount:P.length}),R({isOpen:!0,importing:!1,selectedClassId:null,selectedSubjectId:null})},className:"inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx($e,{className:"mr-2 h-4 w-4"}),"Import"]})]})]}),Z&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-blue-900",children:["Current Academic Session: ",e.jsx("span",{className:"font-semibold",children:Z.name})]}),_&&e.jsxs("p",{className:"text-xs text-blue-700 mt-1",children:["Current Term: ",e.jsx("span",{className:"font-medium",children:_.display_name||_.name})]})]}),e.jsx("div",{className:"text-xs text-blue-600",children:"✓ All scores will be recorded for this session"})]})}),e.jsxs("div",{className:"bg-white shadow rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Select Class and Subject"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Class"}),e.jsxs("select",{value:g,onChange:s=>Ae(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500",children:[e.jsx("option",{value:"",children:"Select a class"}),Array.isArray(P)&&P.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Subject"}),e.jsxs("select",{value:p,onChange:s=>ke(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500",disabled:!g,children:[e.jsx("option",{value:"",children:"Select a subject"}),g&&(()=>{var S;const s=window.location.pathname.includes("/teacher/manage-scores"),t=(o==null?void 0:o.role)==="teacher"||s;let a=[];const l=typeof g=="string"?parseInt(g):g,r=new Map;[...ne,...P].forEach(c=>{if(c&&c.id){const d=typeof c.id=="string"?parseInt(c.id):c.id;r.has(d)||r.set(d,c)}});const i=Array.from(r.values()),m=i.find(c=>!c||!c.id?!1:(typeof c.id=="string"?parseInt(c.id):c.id)===l);return b.component("ManageScores","Subject selection",{selectedClass:g,selectedClassId:l,isTeacher:t,isTeacherRoute:s,userRole:o==null?void 0:o.role,currentPath:window.location.pathname,foundClass:!!m,classObj:m?{id:m.id,name:m.name,hasSubjects:!!m.subjects,subjectsCount:((S=m.subjects)==null?void 0:S.length)||0,subjectsType:typeof m.subjects,subjectsIsArray:Array.isArray(m.subjects),subjects:m.subjects}:null,teacherAssignmentsCount:ne.length,availableClassesCount:P.length,allClassesCount:i.length}),t&&m&&m.subjects?(a=(Array.isArray(m.subjects)?m.subjects:[]).map(d=>{if(typeof d=="object"&&d!==null){const n=typeof d.id=="string"?parseInt(d.id):d.id;return{id:n,name:d.name||d.code||`Subject ${n}`}}const y=typeof d=="string"?parseInt(d):d;return{id:y,name:`Subject ${y}`}}).filter(d=>d&&d.id),b.component("ManageScores","Using subjects from class object",{count:a.length,subjects:a})):(a=Array.isArray(G)?G:[],b.component("ManageScores","Using availableSubjects fallback",{count:a.length,availableSubjectsCount:(G==null?void 0:G.length)||0,reason:t?"class lookup failed":"admin user"})),a.map(c=>e.jsx("option",{value:c.id,children:c.name},c.id))})()]})]})]})]}),g&&p&&e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900",children:["Students (",ge.length,")"]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:()=>{fe(),q(!0),M(null),D(null),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),_&&_.name?A(_.name):A("first")},className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Add Score"]}),e.jsxs("button",{onClick:()=>Array.isArray(j)&&j.length>0&&B(j,g,p),className:"inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",title:"Refresh Scores",children:[e.jsx(Re,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]})}),e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx("input",{type:"text",placeholder:"Search students...",value:O,onChange:s=>ye(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Student"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Admission No."}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"First Term"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Second Term"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Third Term"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Progress"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:ge.map(s=>{var a,l;const t=Se[s.id]||{};return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-red-100 flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-medium text-red-600",children:[(a=s.first_name)==null?void 0:a[0],(l=s.last_name)==null?void 0:l[0]]})})}),e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[s.first_name," ",s.last_name]}),e.jsx("div",{className:"text-sm text-gray-500",children:s.email})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:s.admission_number}),["first","second","third"].map(r=>{const i=t[r];return e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:i?e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-medium text-gray-900",children:[i.total_score," (",i.grade,")"]}),e.jsxs("div",{className:"text-gray-500",children:["1st CA: ",i.first_ca||"N/A"," | 2nd CA: ",i.second_ca||"N/A"," | Exam: ",i.exam_score||"N/A"]})]}):e.jsx("span",{className:"text-gray-400",children:"No score"})},r)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"space-y-2",children:["first","second","third"].map(r=>{const i=t[r],m=i&&(i.first_ca||i.second_ca||i.exam_score);let S="bg-red-100 text-red-800",c="Not Started";if(m){const n=[i.first_ca,i.second_ca,i.exam_score].filter(v=>v!==null&&v!=="").length/3*100;n===100?(S="bg-green-100 text-green-800",c="Complete"):n>=66?(S="bg-blue-100 text-blue-800",c="Almost Done"):(S="bg-yellow-100 text-yellow-800",c="Partial")}return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{className:"text-xs text-gray-500 w-12 capitalize",children:r}),e.jsx("div",{className:"flex-1 bg-gray-200 rounded-full h-1.5",children:e.jsx("div",{className:`h-1.5 rounded-full transition-all duration-300 ${m?c==="Complete"?"bg-green-500":c==="Almost Done"?"bg-blue-500":"bg-yellow-500":"bg-red-500"}`,style:{width:m?`${[i.first_ca,i.second_ca,i.exam_score].filter(d=>d!==null&&d!=="").length/3*100}%`:"0%"}})}),e.jsx("span",{className:`inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium ${S}`,children:c})]},r)})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsxs("div",{className:"flex space-x-2",children:[Object.keys(t).length===0&&e.jsx("button",{onClick:()=>{D(s),M(null),I({first_ca:"",second_ca:"",exam_score:"",total_score:"",grade:"",remark:""}),_&&_.name?A(_.name):A("first"),q(!0)},className:"text-red-600 hover:text-red-900",title:"Add Score",children:e.jsx(pe,{className:"h-4 w-4"})}),Object.keys(t).length>0&&e.jsx("button",{onClick:()=>{const r=Object.values(t)[0];Ee(s,r)},className:"text-blue-600 hover:text-blue-900",title:"Edit Score",children:e.jsx(Ue,{className:"h-4 w-4"})})]})})]},s.id)})})]})})]}),_e&&e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",children:e.jsx("div",{className:"relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white",children:e.jsxs("div",{className:"mt-3",children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:[k?"Edit Score":"Add Score",F&&e.jsxs("span",{className:"block text-sm text-gray-600 mt-1",children:["Student: ",F.first_name," ",F.last_name," (",F.admission_number,")"]}),Z&&e.jsxs("span",{className:"block text-sm text-gray-600 mt-1",children:["Academic Session: ",Z.name]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Term ",_&&e.jsxs("span",{className:"text-xs text-gray-500 font-normal",children:["(Current Term: ",_.display_name||_.name,")"]})]}),e.jsxs("select",{value:U,onChange:s=>{const t=s.target.value;A(t),F&&xe(F.id,t,g,p)},disabled:k!==null,className:`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 ${k!==null?"bg-gray-100 cursor-not-allowed":""}`,children:[e.jsx("option",{value:"first",children:"First Term"}),e.jsx("option",{value:"second",children:"Second Term"}),e.jsx("option",{value:"third",children:"Third Term"})]}),k&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Term cannot be changed when editing an existing score"}),_&&U===_.name&&e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:"✓ This is the current active term"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Student"}),e.jsxs("select",{value:(F==null?void 0:F.id)||"",onChange:s=>{const t=Array.isArray(j)?j.find(a=>a.id==s.target.value):null;D(t),t&&xe(t.id,U)},disabled:k!==null,className:`w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 ${k!==null?"bg-gray-100 cursor-not-allowed":""}`,children:[e.jsx("option",{value:"",children:"Select a student"}),Array.isArray(j)&&j.map(s=>e.jsxs("option",{value:s.id,children:[s.first_name," ",s.last_name," (",s.admission_number,")"]},s.id))]}),k&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Student cannot be changed when editing an existing score"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"1st CA *"}),e.jsx("input",{type:"number",min:"0",max:"100",value:u.first_ca||"",onChange:s=>se("first_ca",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"2nd CA *"}),e.jsx("input",{type:"number",min:"0",max:"100",value:u.second_ca||"",onChange:s=>se("second_ca",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Exam Score *"}),e.jsx("input",{type:"number",min:"0",max:"100",value:u.exam_score||"",onChange:s=>se("exam_score",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Total Score"}),(()=>{const s=(parseFloat(u.first_ca)||0)+(parseFloat(u.second_ca)||0)+(parseFloat(u.exam_score)||0),t=s>100;return e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"number",value:s,readOnly:!0,className:`w-full px-3 py-2 border rounded-md bg-gray-50 ${t?"border-red-500 bg-red-50":"border-gray-300"}`}),t&&e.jsx("p",{className:"text-xs text-red-600 mt-1",children:"⚠️ Total score exceeds 100. Please adjust individual scores."})]})})()]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Grade"}),e.jsx("input",{type:"text",value:ue((parseFloat(u.first_ca)||0)+(parseFloat(u.second_ca)||0)+(parseFloat(u.exam_score)||0)),readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Remark"}),e.jsx("textarea",{value:u.remark,onChange:s=>se("remark",s.target.value),rows:"3",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 mt-6",children:[e.jsx("button",{onClick:fe,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500",children:"Cancel"}),e.jsx("button",{onClick:Fe,disabled:ce,className:"px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50",children:ce?"Saving...":k?"Update":"Save"})]})]})})}),x.isOpen&&(o==null?void 0:o.role)==="teacher"&&e.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center",children:e.jsx("div",{className:"relative bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Import Scores from Excel/CSV"}),e.jsx("button",{onClick:()=>R({isOpen:!1,importing:!1,selectedClassId:null,selectedSubjectId:null}),className:"text-gray-400 hover:text-gray-600",children:e.jsx(De,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Upload an Excel (.xlsx, .xls) or CSV file containing score data.",e.jsx("strong",{className:"block mt-2",children:"First, select a class and subject below, then download the template."})]}),e.jsxs("button",{onClick:async()=>{var s,t;if(!x.selectedClassId||!x.selectedSubjectId){h("Please select a class and subject first before downloading the template");return}try{await C.downloadScoreTemplateTeacher(x.selectedClassId,x.selectedSubjectId),V("Template downloaded successfully")}catch(a){h(((t=(s=a.response)==null?void 0:s.data)==null?void 0:t.message)||a.message||"Failed to download template")}},disabled:!x.selectedClassId||!x.selectedSubjectId,className:"inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:bg-gray-100 disabled:cursor-not-allowed disabled:text-gray-400",title:!x.selectedClassId||!x.selectedSubjectId?"Please select a class and subject first":"Download template with pre-filled student data",children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Download Template"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Select Class ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:x.selectedClassId||"",onChange:s=>{const t=s.target.value;R({...x,selectedClassId:t,selectedSubjectId:""})},className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500",required:!0,children:[e.jsx("option",{value:"",children:"-- Select a class --"}),P&&P.length>0?P.map(s=>{var l,r;const t=s.id||((l=s.class)==null?void 0:l.id),a=s.name||((r=s.class)==null?void 0:r.name);return!t||!a?null:e.jsx("option",{value:t,children:a},t)}):e.jsx("option",{value:"",disabled:!0,children:"No classes available. Please contact admin."})]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"Select the class for which you want to import scores. Only students in this class will be imported."})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Select Subject ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:x.selectedSubjectId||"",onChange:s=>R({...x,selectedSubjectId:s.target.value}),disabled:!x.selectedClassId,className:"block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 disabled:bg-gray-100 disabled:cursor-not-allowed",required:!0,children:[e.jsx("option",{value:"",children:"-- Select a subject --"}),x.selectedClassId&&(()=>{const s=P.find(a=>{var r;return(a.id||((r=a.class)==null?void 0:r.id))==x.selectedClassId});return((s==null?void 0:s.subjects)||[]).map(a=>{var i,m;const l=a.id||((i=a.subject)==null?void 0:i.id),r=a.name||((m=a.subject)==null?void 0:m.name);return!l||!r?null:e.jsx("option",{value:l,children:r},l)})})()]}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:x.selectedClassId?"Select the subject for which you want to import scores.":"Please select a class first"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Select File ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"file",accept:".xlsx,.xls,.csv",onChange:async s=>{const t=s.target.files[0];if(t){if(!x.selectedClassId){h("Please select a class first");return}if(!x.selectedSubjectId){h("Please select a subject first");return}try{const a=await C.getStudentsForClassSubject(x.selectedClassId,x.selectedSubjectId);if((a.data||a||[]).length===0){h("No students found in the selected class and subject combination. Please verify your selection.");return}}catch{h("Failed to validate class and subject. Please check your selection.");return}R({...x,importing:!0});try{const a=await C.importScoresTeacher(t,x.selectedClassId,x.selectedSubjectId);de(a),V(`Import completed: ${a.success_count} successful, ${a.error_count} errors`),g&&p&&j.length>0&&B(j,g,p)}catch(a){h(a.message||"Failed to import scores")}finally{R({...x,importing:!1})}}},className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",disabled:x.importing||!x.selectedClassId||!x.selectedSubjectId})]}),J&&e.jsx("div",{className:"mt-4 p-4 bg-gray-50 rounded-lg",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"mb-2",children:e.jsxs("span",{className:"font-medium text-green-600",children:["Successfully imported: ",J.success_count," scores"]})}),J.error_count>0&&e.jsxs("div",{children:[e.jsxs("span",{className:"font-medium text-red-600",children:["Errors: ",J.error_count]}),e.jsx("div",{className:"mt-2 max-h-32 overflow-y-auto",children:J.errors.map((s,t)=>e.jsxs("div",{className:"text-xs text-red-600 mb-1",children:["Row ",s.row," (",s.admission_number,"): ",s.errors.join(", ")]},t))})]})]})}),x.importing&&e.jsxs("div",{className:"flex items-center justify-center py-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),e.jsx("span",{className:"ml-2 text-sm text-gray-600",children:"Importing..."})]}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsx("button",{onClick:()=>{R({isOpen:!1,importing:!1,selectedClassId:null,selectedSubjectId:null}),de(null)},className:"px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50",children:"Close"})})]})})})]})})};export{ls as default};
