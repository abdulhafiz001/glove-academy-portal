import{a as W,u as q,r as d,j as e,d as n,A as h,f as F}from"./app-17JNjqSJ.js";import{A as y}from"./AdminLayout-DXkI0PI6.js";import{S as L}from"./shield-Dhn-V6E4.js";import{S as G}from"./search-Dk6ZNiIw.js";import{B as E}from"./book-open-D3qBa7nK.js";import{E as j}from"./eye-0BP9KD6k.js";import{A as H}from"./arrow-left-DS4rNrD0.js";import{D as K}from"./download-7IDGFHuP.js";import{F as Q}from"./file-text-Znh3F_nC.js";import"./users-BUbPeWYP.js";import"./calendar-BfCctGZ3.js";import"./user-CAmUnVMn.js";import"./log-out-Bc-nJCmd.js";import"./menu-BL5-W5Xp.js";const me=()=>{var R,k,T;const{user:s,getCurrentUserWithFreshStatus:D}=W(),{showError:i,showSuccess:U}=q(),[m,O]=d.useState(""),[u,Y]=d.useState("all"),[x,f]=d.useState([]),[V,o]=d.useState(!1),[N,v]=d.useState(null),[g,b]=d.useState(null),[p,$]=d.useState("current"),B=d.useMemo(()=>x.reduce((a,t)=>{var r;return a+(((r=t.students)==null?void 0:r.length)||0)},0),[x]),w=a=>{if(!a)return"unknown";const t=a.toLowerCase();return t.includes("jss")?"jss":t.includes("ss")?"ss":"unknown"};d.useEffect(()=>{(async()=>{if(s)try{n.component("Results","Initializing component",{userRole:s==null?void 0:s.role,isFormTeacher:s==null?void 0:s.is_form_teacher});const t=await D();n.component("Results","Fresh user data received",{role:t==null?void 0:t.role,isFormTeacher:t==null?void 0:t.is_form_teacher}),(t==null?void 0:t.role)==="admin"||t!=null&&t.is_form_teacher?(n.component("Results","User has access, fetching classes"),await M()):(n.component("Results","User does not have access"),i("Access denied. Only admins and form teachers can view results."))}catch{}})()},[s==null?void 0:s.id,s==null?void 0:s.role]);const M=async()=>{var a;try{o(!0),n.component("Results","fetchClasses called",{userRole:s==null?void 0:s.role,isFormTeacher:s==null?void 0:s.is_form_teacher});let t;if((s==null?void 0:s.role)==="admin")n.component("Results","fetchClasses - Fetching as admin"),t=await h.getClasses();else if((s==null?void 0:s.role)==="teacher")if(s!=null&&s.is_form_teacher)n.component("Results","fetchClasses - Fetching as form teacher"),t=await h.getTeacherAdminClasses();else{n.component("Results","fetchClasses - Access denied, not a form teacher"),i("Access denied. Only form teachers can view results."),f([]),o(!1);return}else{n.warn("Results - Unknown user role:",s==null?void 0:s.role),i("Unknown user role"),f([]),o(!1);return}let r;t.data&&Array.isArray(t.data)?r=t.data:Array.isArray(t)?r=t:t.data&&t.data.data&&Array.isArray(t.data.data)?r=t.data.data:(n.warn("Results - Unexpected response structure:",t),r=[]),n.component("Results","fetchClasses - Data loaded",{count:r.length,isArray:Array.isArray(r)}),Array.isArray(r)||(n.error("Results - Classes data is not an array:",r),r=[]),f(r)}catch(t){((a=t.response)==null?void 0:a.status)===403?(i("Access denied. You do not have permission to view results."),f([])):i("Failed to load classes")}finally{o(!1)}},P=async a=>{var t;try{o(!0);let r;const l={};if(p&&p!=="current"&&(l.term=p),(s==null?void 0:s.role)==="admin")r=await h.getAdminClassResults(a,l);else if((s==null?void 0:s.role)==="teacher"&&(s!=null&&s.is_form_teacher))r=await h.getTeacherAdminClassResults(a,l);else{i("Access denied. You do not have permission to view class results."),o(!1);return}const c=r.data||r;b(c)}catch(r){((t=r.response)==null?void 0:t.status)===403?i("Access denied. You do not have permission to view this class results."):i("Failed to load class results")}finally{o(!1)}},A=async a=>{var t;try{let r;if((s==null?void 0:s.role)==="admin")r=await h.getAdminStudentResults(a);else if((s==null?void 0:s.role)==="teacher"&&(s!=null&&s.is_form_teacher))r=await h.getTeacherStudentResults(a);else{i("Access denied. You do not have permission to view this student's results.");return}(s==null?void 0:s.role)==="admin"?F.visit(`/admin/students/${a}/results`):(s==null?void 0:s.role)==="teacher"&&(s!=null&&s.is_form_teacher)&&F.visit(`/teacher/student-results/${a}`)}catch(r){((t=r.response)==null?void 0:t.status)===403?i("Access denied. You do not have permission to view this student's results."):i("Failed to load student results")}},C=async a=>{v(a),await P(a.id)},z=()=>{v(null),b(null)},J=a=>{switch(a){case"primary":return"bg-blue-100 text-blue-800";case"jss":return"bg-green-100 text-green-800";case"sss":return"bg-purple-100 text-purple-800";default:return"bg-gray-100 text-gray-800"}},S=d.useMemo(()=>{if(!Array.isArray(x))return[];let a=x;return u!=="all"&&(a=a.filter(t=>w(t.name)===u)),m&&(a=a.filter(t=>{var r;return t.name.toLowerCase().includes(m.toLowerCase())||((r=t.form_teacher)==null?void 0:r.name)&&t.form_teacher.name.toLowerCase().includes(m.toLowerCase())})),a},[x,u,m]),_=a=>{if(!a.results||Object.keys(a.results).length===0)return 0;let t=0,r=0;return Object.values(a.results).forEach(l=>{l.forEach(c=>{t+=c.total_score||0,r++})}),r>0?Math.round(t/r*100)/100:0};return V?e.jsx(y,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"})})}):(s==null?void 0:s.role)==="teacher"&&!(s!=null&&s.is_form_teacher)?e.jsx(y,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(L,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Only form teachers can access the results page. Please contact the administrator if you believe this is an error."})]})}):e.jsx(y,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Results Management"}),e.jsx("p",{className:"text-gray-600",children:(s==null?void 0:s.role)==="admin"?"View and manage all class results":"View results for your assigned classes"})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-gray-500",children:"Total Students"}),e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:B}),e.jsxs("div",{className:"text-sm text-gray-500",children:[x.length," Classes"]})]})]}),(s==null?void 0:s.role)==="teacher"&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(L,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-blue-800",children:"Form Teacher Access"}),e.jsx("div",{className:"mt-2 text-sm text-blue-700",children:e.jsx("p",{children:"You can only view results for classes where you are assigned as the form teacher."})})]})]})}),N?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("button",{onClick:z,className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Back to Classes"]}),e.jsxs("h3",{className:"text-xl font-semibold text-gray-900",children:[N.name," - Results"]})]}),g?e.jsxs("div",{className:"bg-white shadow rounded-lg",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"text-lg font-medium text-gray-900",children:["Student Results (",((R=g.results)==null?void 0:R.length)||0," students)"]}),e.jsx("div",{className:"flex space-x-2",children:e.jsxs("button",{className:"inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:[e.jsx(K,{className:"h-4 w-4 mr-1"}),"Export"]})})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Student"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Admission No."}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Average Score"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:(k=g.results)==null?void 0:k.map(a=>{var l,c;const t=a.student,r=_(t);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-red-100 flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-medium text-red-600",children:[(l=t.first_name)==null?void 0:l[0],(c=t.last_name)==null?void 0:c[0]]})})}),e.jsxs("div",{className:"ml-4",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[t.first_name," ",t.last_name]}),e.jsx("div",{className:"text-sm text-gray-500",children:t.email})]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:t.admission_number}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r>0?`${r}%`:"No scores"})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:e.jsx("button",{onClick:()=>A(t.id),className:"text-red-600 hover:text-red-900",children:e.jsx(j,{className:"h-4 w-4"})})})]},t.id)})})]})}),(s==null?void 0:s.role)==="teacher"&&(s==null?void 0:s.is_form_teacher)&&e.jsxs("div",{className:"mt-6 p-6 bg-gray-50 rounded-lg",children:[e.jsx("h5",{className:"text-lg font-medium text-gray-900 mb-4",children:"Individual Student Results"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:(T=g.results)==null?void 0:T.map(a=>{var l,c;const t=a.student,r=_(t);return e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-3",children:[e.jsx("div",{className:"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center",children:e.jsxs("span",{className:"text-sm font-medium text-red-600",children:[(l=t.first_name)==null?void 0:l[0],(c=t.last_name)==null?void 0:c[0]]})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h6",{className:"text-sm font-medium text-gray-900",children:[t.first_name," ",t.last_name]}),e.jsx("p",{className:"text-xs text-gray-500",children:t.admission_number})]})]}),e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Average:"}),e.jsx("span",{className:"font-medium text-gray-900",children:r>0?`${r}%`:"No scores"})]})}),e.jsxs("button",{onClick:()=>A(t.id),className:"w-full mt-3 inline-flex items-center justify-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"View Details"]})]},t.id)})})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(Q,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No results available"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No results have been published for this class yet."})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white shadow rounded-lg p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Search Classes"}),e.jsxs("div",{className:"relative",children:[e.jsx(G,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx("input",{type:"text",placeholder:"Search by class name or form teacher...",value:m,onChange:a=>O(a.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500"})]})]}),e.jsxs("div",{className:"sm:w-48",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Level"}),e.jsxs("select",{value:u,onChange:a=>Y(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500",children:[e.jsx("option",{value:"all",children:"All Levels"}),e.jsx("option",{value:"primary",children:"Primary"}),e.jsx("option",{value:"jss",children:"Junior Secondary"}),e.jsx("option",{value:"sss",children:"Senior Secondary"})]})]}),e.jsxs("div",{className:"sm:w-48",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Term"}),e.jsxs("select",{value:p,onChange:a=>$(a.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500",children:[e.jsx("option",{value:"current",children:"Current Term"}),e.jsx("option",{value:"first",children:"First Term"}),e.jsx("option",{value:"second",children:"Second Term"}),e.jsx("option",{value:"third",children:"Third Term"})]})]})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:S.map(a=>{var l;const t=w(a.name),r=a.students_count||0;return e.jsxs("div",{className:"bg-white shadow rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer border border-gray-200",onClick:()=>C(a),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center",children:e.jsx(E,{className:"h-5 w-5 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:a.name}),e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${J(t)}`,children:t.toUpperCase()})]})]}),e.jsx(j,{className:"h-5 w-5 text-gray-400"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Form Teacher:"}),e.jsx("span",{className:"font-medium text-gray-900",children:((l=a.form_teacher)==null?void 0:l.name)||"Not Assigned"})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Students:"}),e.jsx("span",{className:"font-medium text-gray-900",children:r})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Status:"}),e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:"Active"})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200",children:e.jsxs("button",{onClick:c=>{c.stopPropagation(),C(a)},className:"w-full inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"View Results"]})})]},a.id)})}),S.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(E,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No classes found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:m?"Try adjusting your search criteria.":"No classes are available for your access level."})]})]})]})})};export{me as default};
